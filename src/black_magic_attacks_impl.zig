const magics_generation = @import("magics_generation.zig");
const Square = @import("square.zig").Square;

pub const MagicEntry = struct {
    mask: u64,
    magic: u64,
    offs: u32,

    pub fn isMaskInverted() bool {
        return true;
    }

    pub inline fn getRookIndex(self: MagicEntry, occ: u64) u64 {
        return ((occ | self.mask) *% self.magic >> (64 - 12)) + self.offs;
    }

    pub inline fn getBishopIndex(self: MagicEntry, occ: u64) u64 {
        return ((occ | self.mask) *% self.magic >> (64 - 9)) + self.offs;
    }
};

// magics by Volker Annuss
pub const bishop_magics: [64]MagicEntry = .{
    .{ .offs = 66157, .mask = 18428694421974023679, .magic = 1187473109101317119 },
    .{ .offs = 71730, .mask = 18446673567257459711, .magic = 9223336714375004157 },
    .{ .offs = 37781, .mask = 18446743798293722623, .magic = 288441550701068800 },
    .{ .offs = 21015, .mask = 18446744072633576447, .magic = 1170795303134035968 },
    .{ .offs = 47590, .mask = 18446744073671530495, .magic = 13853037273714524160 },
    .{ .offs = 835, .mask = 18446744065051963391, .magic = 2648129775020802048 },
    .{ .offs = 23592, .mask = 18446741857371152383, .magic = 578730278520913668 },
    .{ .offs = 30599, .mask = 18446176691079331839, .magic = 1155182238468407424 },
    .{ .offs = 68776, .mask = 18437719247841787903, .magic = 18420565800289023999 },
    .{ .offs = 19959, .mask = 18428694421974024191, .magic = 593981333727348737 },
    .{ .offs = 21783, .mask = 18446673567257329663, .magic = 288653413114708096 },
    .{ .offs = 64836, .mask = 18446743798259908607, .magic = 306245323880337408 },
    .{ .offs = 23417, .mask = 18446744063976144895, .magic = 2310347158529769472 },
    .{ .offs = 66724, .mask = 18446741857366966271, .magic = 1187261314343337984 },
    .{ .offs = 74542, .mask = 18446176691079348223, .magic = 9188469001234153344 },
    .{ .offs = 67266, .mask = 18445609308449144831, .magic = 578171627018125376 },
    .{ .offs = 26575, .mask = 18442231660775734783, .magic = 9222949822267379705 },
    .{ .offs = 67543, .mask = 18437719247841917951, .magic = 9223020191524333565 },
    .{ .offs = 24409, .mask = 18428694421940729343, .magic = 2306265224900983809 },
    .{ .offs = 30779, .mask = 18446673558600936447, .magic = 4647151869788945290 },
    .{ .offs = 17384, .mask = 18446741581957421055, .magic = 2314815028390789136 },
    .{ .offs = 18778, .mask = 18446176690007683071, .magic = 18437719281702141935 },
    .{ .offs = 65109, .mask = 18445609308453330943, .magic = 9223363241302802431 },
    .{ .offs = 20184, .mask = 18444474543197110271, .magic = 9221115838862475263 },
    .{ .offs = 38240, .mask = 18444487867259288575, .magic = 1090988818544 },
    .{ .offs = 16459, .mask = 18442231660809025535, .magic = 9223230887045427193 },
    .{ .offs = 17432, .mask = 18437719239318433791, .magic = 9223090009958119421 },
    .{ .offs = 81040, .mask = 18428692205904059903, .magic = 4570867472252272639 },
    .{ .offs = 84946, .mask = 18446106185164110847, .magic = 292734589976199165 },
    .{ .offs = 18276, .mask = 18445609034107058175, .magic = 2305878434105819152 },
    .{ .offs = 8512, .mask = 18444474544268767231, .magic = 612472197655543809 },
    .{ .offs = 78544, .mask = 18442205014827982847, .magic = 2265045493362695 },
    .{ .offs = 19974, .mask = 18445615974745634815, .magic = 553992241216 },
    .{ .offs = 23850, .mask = 18444487875781718015, .magic = 276996120608 },
    .{ .offs = 11056, .mask = 18442229478797074431, .magic = 27023813833162784 },
    .{ .offs = 68019, .mask = 18437151933931044863, .magic = 14989104351765610624 },
    .{ .offs = 85965, .mask = 18427559794152570367, .magic = 1152957239137415242 },
    .{ .offs = 80524, .mask = 18444404311622941695, .magic = 9205355920559695872 },
    .{ .offs = 38221, .mask = 18442205289172170751, .magic = 1188932777689485200 },
    .{ .offs = 64647, .mask = 18437666504634789887, .magic = 9191846633066727416 },
    .{ .offs = 61320, .mask = 18446181115098558463, .magic = 279189160064 },
    .{ .offs = 67281, .mask = 18445618156487565311, .magic = 139594580032 },
    .{ .offs = 79076, .mask = 18443929280722223103, .magic = 279198499008 },
    .{ .offs = 17115, .mask = 18441114487701372927, .magic = 4503601791385728 },
    .{ .offs = 50718, .mask = 18435484901701451775, .magic = 1152921764453941296 },
    .{ .offs = 24659, .mask = 18424225731840835071, .magic = 2307531983360360472 },
    .{ .offs = 38291, .mask = 18437736736746896383, .magic = 18446743798562688988 },
    .{ .offs = 30605, .mask = 18428729399784241151, .magic = 68988172306 },
    .{ .offs = 37759, .mask = 18446741857371152383, .magic = 576460886529573376 },
    .{ .offs = 4639, .mask = 18446739641032753151, .magic = 594475220056658440 },
    .{ .offs = 21759, .mask = 18446733009332731903, .magic = 576460752563503233 },
    .{ .offs = 67799, .mask = 18446721936374366207, .magic = 1125900041076608 },
    .{ .offs = 22841, .mask = 18446699801153110015, .magic = 576460756600479808 },
    .{ .offs = 66689, .mask = 18446656078352351231, .magic = 603338863802321408 },
    .{ .offs = 62548, .mask = 18446708820483505663, .magic = 18446742973123131421 },
    .{ .offs = 66597, .mask = 18446673567257459711, .magic = 18428729606210057999 },
    .{ .offs = 86749, .mask = 18446176691079331839, .magic = 1152921573842288770 },
    .{ .offs = 69558, .mask = 18445609308449144831, .magic = 9203950263191257135 },
    .{ .offs = 61589, .mask = 18443911593243705343, .magic = 9188469139741638527 },
    .{ .offs = 62533, .mask = 18441076915902087167, .magic = 18442803424035078081 },
    .{ .offs = 64387, .mask = 18435410299260502015, .magic = 610242147571982367 },
    .{ .offs = 26581, .mask = 18424217262266253311, .magic = 26177172852973578 },
    .{ .offs = 76355, .mask = 18437719247841787903, .magic = 594615890450845658 },
    .{ .offs = 11140, .mask = 18428694421974023679, .magic = 1152922330840178696 },
};
pub const rook_magics: [64]MagicEntry = .{
    .{ .offs = 10890, .mask = 18446461494909402753, .magic = 9234631121814487039 },
    .{ .offs = 56054, .mask = 18446178916109254019, .magic = 6916402019615277055 },
    .{ .offs = 67495, .mask = 18445613758508956549, .magic = 18442234976255475711 },
    .{ .offs = 72797, .mask = 18444483443308361609, .magic = 13511417407733898 },
    .{ .offs = 17179, .mask = 18442222812907171729, .magic = 13512448205127728 },
    .{ .offs = 63978, .mask = 18437701552104791969, .magic = 9008441047646240 },
    .{ .offs = 56650, .mask = 18428659030500032449, .magic = 13511211211554864 },
    .{ .offs = 15929, .mask = 18410573987290513281, .magic = 18421974885628248056 },
    .{ .offs = 55905, .mask = 18446461494909370879, .magic = 9205348825003917308 },
    .{ .offs = 26301, .mask = 18446178916109222911, .magic = 21992397144066 },
    .{ .offs = 78100, .mask = 18445613758508926463, .magic = 26389411528776 },
    .{ .offs = 86245, .mask = 18444483443308333567, .magic = 9223345648611360696 },
    .{ .offs = 75228, .mask = 18442222812907147775, .magic = 18446691290705821615 },
    .{ .offs = 31661, .mask = 18437701552104776191, .magic = 26391501865056 },
    .{ .offs = 38053, .mask = 18428659030500033023, .magic = 18446717683547242472 },
    .{ .offs = 37433, .mask = 18410573987290513919, .magic = 26389090795544 },
    .{ .offs = 74747, .mask = 18446461494901210879, .magic = 13510901978890243 },
    .{ .offs = 53847, .mask = 18446178916101258751, .magic = 844476478521343 },
    .{ .offs = 70952, .mask = 18445613758501223423, .magic = 18446181089329217527 },
    .{ .offs = 49447, .mask = 18444483443301152767, .magic = 9205920450792660991 },
    .{ .offs = 62629, .mask = 18442222812901011455, .magic = 18446462461260324863 },
    .{ .offs = 58996, .mask = 18437701552100728831, .magic = 8939786031088007199 },
    .{ .offs = 36009, .mask = 18428659030500163583, .magic = 2323998178495432720 },
    .{ .offs = 21230, .mask = 18410573987290644479, .magic = 288371136597606656 },
    .{ .offs = 51882, .mask = 18446461492812250879, .magic = 18049583150530568 },
    .{ .offs = 11841, .mask = 18446178914062433791, .magic = 4505798785105924 },
    .{ .offs = 25794, .mask = 18445613756529245183, .magic = 18446180024110022647 },
    .{ .offs = 49689, .mask = 18444483441462867967, .magic = 18356529144533024761 },
    .{ .offs = 63400, .mask = 18442222811330113535, .magic = 13835059154257051616 },
    .{ .offs = 33958, .mask = 18437701551064604671, .magic = 2308130543272738823 },
    .{ .offs = 21991, .mask = 18428659030533586943, .magic = 13833926657740128127 },
    .{ .offs = 45618, .mask = 18410573987324067839, .magic = 578702106657038400 },
    .{ .offs = 70134, .mask = 18446460958038490879, .magic = 2305852801742274608 },
    .{ .offs = 75944, .mask = 18446178392123244031, .magic = 581969641496 },
    .{ .offs = 68392, .mask = 18445613251702815743, .magic = 1112398102552 },
    .{ .offs = 66472, .mask = 18444482970861959167, .magic = 4611686574627225624 },
    .{ .offs = 23236, .mask = 18442222409180246015, .magic = 36169744961110010 },
    .{ .offs = 19067, .mask = 18437701285816819711, .magic = 4611712960757628934 },
    .{ .offs = 0, .mask = 18428659039089967103, .magic = 18446743523949527039 },
    .{ .offs = 43566, .mask = 18410573995880447999, .magic = 140874929406016 },
    .{ .offs = 29810, .mask = 18446324055955930879, .magic = 2305845220786317312 },
    .{ .offs = 65558, .mask = 18446044775690665471, .magic = 18446737474441966591 },
    .{ .offs = 77684, .mask = 18445484016136879103, .magic = 276144592896 },
    .{ .offs = 73350, .mask = 18444362497029306367, .magic = 2305843214839435264 },
    .{ .offs = 61765, .mask = 18442119458814160895, .magic = 18446743455209082877 },
    .{ .offs = 49282, .mask = 18437633382383869951, .magic = 13832788662204502015 },
    .{ .offs = 78840, .mask = 18428661229523288063, .magic = 68853737476 },
    .{ .offs = 82904, .mask = 18410576186313768959, .magic = 18445618103606814718 },
    .{ .offs = 24594, .mask = 18411277122820570879, .magic = 5669358141480 },
    .{ .offs = 9513, .mask = 18411838968950554111, .magic = 571239694356 },
    .{ .offs = 29012, .mask = 18412399711257099263, .magic = 9223372221542596648 },
    .{ .offs = 27684, .mask = 18413521195870189567, .magic = 4611686156948013096 },
    .{ .offs = 27901, .mask = 18415764165096370175, .magic = 8646911422261395496 },
    .{ .offs = 61477, .mask = 18420250103548731391, .magic = 103093927960 },
    .{ .offs = 25719, .mask = 18429221980453453823, .magic = 1769914688190546000 },
    .{ .offs = 50020, .mask = 18411136937243934719, .magic = 2306924928660668456 },
    .{ .offs = 41547, .mask = 9367204646130482943, .magic = 18446730325249744830 },
    .{ .offs = 4750, .mask = 9511037255406190079, .magic = 4611688767357457345 },
    .{ .offs = 6014, .mask = 9654587285881748479, .magic = 13799028157677500191 },
    .{ .offs = 41529, .mask = 9941687346832865279, .magic = 18446181121465744750 },
    .{ .offs = 84192, .mask = 10515887468735098879, .magic = 17221764906077391870 },
    .{ .offs = 33433, .mask = 11664287712539566079, .magic = 12673129420131140610 },
    .{ .offs = 8555, .mask = 13961088200148500479, .magic = 17182358461140924414 },
    .{ .offs = 1009, .mask = 9331317138511593471, .magic = 562962977269890 },
};

var attacks: [88507]u64 = undefined;
pub fn init() void {
    magics_generation.generateBishopAttackArrayInPlace(bishop_magics, &attacks);
    magics_generation.generateRookAttackArrayInPlace(rook_magics, &attacks);
}

pub fn getBishopAttacks(square: Square, blockers: u64) u64 {
    return (&attacks)[@intCast(bishop_magics[square.toInt()].getBishopIndex(blockers))];
}
pub fn getRookAttacks(square: Square, blockers: u64) u64 {
    return (&attacks)[@intCast(rook_magics[square.toInt()].getRookIndex(blockers))];
}
